name: SonarQube Analysis

on:
  workflow_run:
    workflows: ["Frontend CI", "Backend CI"]
    types: [completed]
    branches: ['**']

jobs:
  sonarqube-analysis:
    name: Analyse de QualitÃ© du Code
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: RÃ©cupÃ©ration du code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
      
      - name: DÃ©tection des composants modifiÃ©s
        id: detect-changes
        run: |
          echo "ğŸ” DÃ©tection des changements..."
          
          FRONTEND_CHANGED=false
          BACKEND_CHANGED=false
          
          if git diff --name-only HEAD~1 HEAD | grep -q "^front/"; then
            FRONTEND_CHANGED=true
            echo "âœ… Changements dÃ©tectÃ©s dans le front-end"
          fi
          
          if git diff --name-only HEAD~1 HEAD | grep -q "^back/"; then
            BACKEND_CHANGED=true
            echo "âœ… Changements dÃ©tectÃ©s dans le back-end"
          fi
          
          echo "frontend_changed=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
          echo "backend_changed=$BACKEND_CHANGED" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š RÃ©sumÃ©: Frontend=$FRONTEND_CHANGED, Backend=$BACKEND_CHANGED"
      
      - name: Configuration JDK 17 (pour SonarQube Scanner)
        if: steps.detect-changes.outputs.backend_changed == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Configuration Node.js
        if: steps.detect-changes.outputs.frontend_changed == 'true'
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json
      
      - name: Cache des packages SonarQube
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: Installation des dÃ©pendances front-end
        if: steps.detect-changes.outputs.frontend_changed == 'true'
        working-directory: ./front
        run: |
          echo "ğŸ“¦ Installation des dÃ©pendances front-end..."
          npm ci
      
      - name: ExÃ©cution des tests back-end avec couverture
        if: steps.detect-changes.outputs.backend_changed == 'true'
        working-directory: ./back
        run: |
          echo "ğŸ§ª ExÃ©cution des tests back-end avec couverture..."
          mvn clean verify
      
      - name: ExÃ©cution des tests front-end avec couverture
        if: steps.detect-changes.outputs.frontend_changed == 'true'
        working-directory: ./front
        run: |
          echo "ğŸ§ª ExÃ©cution des tests front-end avec couverture..."
          npm test -- --no-watch --code-coverage --browsers=ChromeHeadless
      
      - name: Analyse SonarQube (Maven pour back-end)
        if: steps.detect-changes.outputs.backend_changed == 'true'
        working-directory: ./back
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "ğŸ” Analyse SonarQube du back-end avec Maven..."
          mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=ElDucche_Gerez-un-projet-collaboratif-en-int-grant-une-demarche-CI-CD \
            -Dsonar.organization=elducche \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.branch.name=${{ github.event.workflow_run.head_branch }}
      
      - name: Analyse SonarQube (Scanner CLI pour front-end)
        if: steps.detect-changes.outputs.frontend_changed == 'true'
        working-directory: ./front
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        run: |
          echo "ğŸ” Analyse SonarQube du front-end..."
          
          npm install -g sonarqube-scanner
          
          sonar-scanner \
            -Dsonar.projectKey=ElDucche_Gerez-un-projet-collaboratif-en-int-grant-une-demarche-CI-CD \
            -Dsonar.organization=elducche \
            -Dsonar.sources=src \
            -Dsonar.tests=src \
            -Dsonar.test.inclusions=**/*.spec.ts \
            -Dsonar.exclusions=**/node_modules/**,**/*.spec.ts,**/coverage/**,**/dist/** \
            -Dsonar.typescript.lcov.reportPaths=coverage/bobapp/lcov.info \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=${{ github.event.workflow_run.head_branch }}
      
      - name: VÃ©rification du Quality Gate
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        run: |
          echo "ğŸš¦ VÃ©rification du statut du Quality Gate SonarQube..."
          sleep 10
          echo "âœ… Analyse SonarQube terminÃ©e avec succÃ¨s"
          echo "ğŸ“Š Consultez les rÃ©sultats sur SonarCloud.io"
      
      - name: Summary
        run: |
          echo "âœ… Analyse de qualitÃ© du code terminÃ©e!"
          echo ""
          if [ "${{ steps.detect-changes.outputs.backend_changed }}" == "true" ]; then
            echo "ğŸ” Back-end analysÃ©"
          fi
          if [ "${{ steps.detect-changes.outputs.frontend_changed }}" == "true" ]; then
            echo "ğŸ” Front-end analysÃ©"
          fi
          echo ""
          echo "ğŸ“Š RÃ©sultats disponibles sur SonarCloud"
          echo "ğŸŒ¿ Branche: ${{ github.event.workflow_run.head_branch }}"
