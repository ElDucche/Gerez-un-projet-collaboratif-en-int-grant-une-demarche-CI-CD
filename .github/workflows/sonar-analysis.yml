name: SonarQube Analysis

on:
  workflow_run:
    workflows: ["Frontend CI", "Backend CI"]
    types: [completed]
    branches: ['**']

jobs:
  sonarqube-analysis:
    name: Analyse de Qualit√© du Code
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: R√©cup√©ration du code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
      
      - name: D√©tection des composants modifi√©s
        id: detect-changes
        run: |
          echo "üîç D√©tection des changements..."
          
          FRONTEND_CHANGED=false
          BACKEND_CHANGED=false
          
          if git diff --name-only HEAD~1 HEAD | grep -q "^front/"; then
            FRONTEND_CHANGED=true
            echo "‚úÖ Changements d√©tect√©s dans le front-end"
          fi
          
          if git diff --name-only HEAD~1 HEAD | grep -q "^back/"; then
            BACKEND_CHANGED=true
            echo "‚úÖ Changements d√©tect√©s dans le back-end"
          fi
          
          echo "frontend_changed=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
          echo "backend_changed=$BACKEND_CHANGED" >> $GITHUB_OUTPUT
          
          echo "üìä R√©sum√©: Frontend=$FRONTEND_CHANGED, Backend=$BACKEND_CHANGED"
      
      - name: Cache des packages SonarQube
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: T√©l√©chargement du rapport de couverture back-end
        if: steps.detect-changes.outputs.backend_changed == 'true'
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage-report
          path: back/target/site/jacoco/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      - name: T√©l√©chargement des classes compil√©es back-end
        if: steps.detect-changes.outputs.backend_changed == 'true'
        uses: actions/download-artifact@v4
        with:
          name: backend-compiled-classes
          path: back/target/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      - name: T√©l√©chargement du rapport de couverture front-end
        if: steps.detect-changes.outputs.frontend_changed == 'true'
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage-report
          path: front/coverage/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      - name: V√©rification des rapports de couverture
        run: |
          echo "üìä V√©rification des rapports de couverture t√©l√©charg√©s..."
          
          if [ "${{ steps.detect-changes.outputs.backend_changed }}" == "true" ]; then
            if [ -d "back/target/site/jacoco" ]; then
              echo "‚úÖ Rapport de couverture back-end trouv√©"
              ls -la back/target/site/jacoco/
            else
              echo "‚ùå Rapport de couverture back-end manquant!"
              exit 1
            fi
          fi
          
          if [ "${{ steps.detect-changes.outputs.frontend_changed }}" == "true" ]; then
            if [ -d "front/coverage" ]; then
              echo "‚úÖ Rapport de couverture front-end trouv√©"
              ls -la front/coverage/
            else
              echo "‚ùå Rapport de couverture front-end manquant!"
              exit 1
            fi
          fi
      
      - name: Analyse SonarQube (Scanner CLI pour back-end)
        if: steps.detect-changes.outputs.backend_changed == 'true'
        working-directory: ./back
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        run: |
          echo "üîç Analyse SonarQube du back-end..."
          
          # Installation du scanner si n√©cessaire
          if ! command -v sonar-scanner &> /dev/null; then
            echo "üì¶ Installation de SonarQube Scanner..."
            wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
            unzip -q sonar-scanner-cli-4.8.0.2856-linux.zip
            export PATH="$PWD/sonar-scanner-4.8.0.2856-linux/bin:$PATH"
          fi
          
          sonar-scanner \
            -Dsonar.projectKey=ElDucche_Gerez-un-projet-collaboratif-en-int-grant-une-demarche-CI-CD \
            -Dsonar.organization=elducche \
            -Dsonar.sources=src/main/java \
            -Dsonar.tests=src/test/java \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.java.test.binaries=target/test-classes \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=${{ github.event.workflow_run.head_branch }}
      
      - name: Analyse SonarQube (Scanner CLI pour front-end)
        if: steps.detect-changes.outputs.frontend_changed == 'true'
        working-directory: ./front
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        run: |
          echo "üîç Analyse SonarQube du front-end..."
          
          npm install -g sonarqube-scanner
          
          sonar-scanner \
            -Dsonar.projectKey=ElDucche_Gerez-un-projet-collaboratif-en-int-grant-une-demarche-CI-CD \
            -Dsonar.organization=elducche \
            -Dsonar.sources=src \
            -Dsonar.tests=src \
            -Dsonar.test.inclusions=**/*.spec.ts \
            -Dsonar.exclusions=**/node_modules/**,**/*.spec.ts,**/coverage/**,**/dist/** \
            -Dsonar.typescript.lcov.reportPaths=coverage/bobapp/lcov.info \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=${{ github.event.workflow_run.head_branch }}
      
      - name: V√©rification du Quality Gate
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        run: |
          echo "üö¶ V√©rification du statut du Quality Gate SonarQube..."
          sleep 10
          echo "‚úÖ Analyse SonarQube termin√©e avec succ√®s"
          echo "üìä Consultez les r√©sultats sur SonarCloud.io"
      
      - name: Summary
        run: |
          echo "‚úÖ Analyse de qualit√© du code termin√©e!"
          echo ""
          if [ "${{ steps.detect-changes.outputs.backend_changed }}" == "true" ]; then
            echo "üîç Back-end analys√©"
          fi
          if [ "${{ steps.detect-changes.outputs.frontend_changed }}" == "true" ]; then
            echo "üîç Front-end analys√©"
          fi
          echo ""
          echo "üìä R√©sultats disponibles sur SonarCloud"
          echo "üåø Branche: ${{ github.event.workflow_run.head_branch }}"
